 <!--start main wrapper-->
 <main class="main-wrapper">
     <div class="main-content">

         <div class="row">
             <div class="col-md-8 my-2">
                 <h3 class="fmon">Dashboard</h3>
             </div>

             <!-- <div class="col-md-4 my-2">
                 <div class="row">
                     <div class="col-md-6 my-1">
                         <select class="form-select date-selection" name="date-selection" id="date-selection-1">
                             <option value="Today" selected>Today</option>
                             <option value="Yesterday">Yesterday</option>
                             <option value="This Week">This Week</option>
                             <option value="Last Week">Last Week</option>
                             <option value="This Month">This Month</option>
                             <option value="Last Month">Last Month</option>
                             <option value="Custom">Custom</option>
                         </select>
                         <div class="d-flex d-none date" id="">
                             <input class="form-control " type="date" class="">
                             <button class="btn btnRefresh" id=""> <img
                                     src="<?php echo base_url(); ?>assets/images/reload.svg" alt=""
                                     width="15px"></button>
                         </div>
                     </div>
                     <div class="col-md-6 my-1">
                         <select name="" id="" class="form-select fsele ">
                             <option value="" selected>Filter</option>
                             <option value="">Reports</option>
                             <option value="">Stock Items</option>
                             <option value="">Treatments Administered</option>

                         </select>
                     </div>
                 </div>

             </div> -->
         </div>
         <div class="row my-2">
             <div class="col-md-9">
                 <div class="row">
                     <div class="my-2 col-md-4">
                         <div class=" mCard p-2">
                             <div class="card-body">
                                 <div class="d-flex justify-content-between align-items-center">
                                     <div class="d-flex justify-content-between align-items-center">
                                         <img src="<?php echo base_url(); ?>assets/images/ous.svg" alt="">
                                         <p class="m-0 ms-2 fs1">Reports</p>
                                     </div>
                                     <div>
                                         <img src="<?php echo base_url(); ?>assets/images/ellep.png" alt="">
                                     </div>
                                 </div>
                                 <div class="row">
                                     <div class="col-md-6 my-1">
                                         <p class="fs2">Financial & Inventory</p>
                                         <div class="mt-2">

                                         </div>
                                     </div>
                                     <div class="col-md-6 my-1 d-flex justify-content-end align-items-center">
                                         <img class="img-fluid" src="<?php echo base_url(); ?>assets/images/onof.svg"
                                             alt="">
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                     <div class="my-2 col-md-4">
                         <div class=" mCard p-2">
                             <div class="card-body">
                                 <div class="d-flex justify-content-between align-items-center">
                                     <div class="d-flex justify-content-between align-items-center">
                                         <img src="<?php echo base_url(); ?>assets/images/op.svg" alt="">
                                         <p class="m-0 ms-2 fs1"> Treatments Administered</p>
                                     </div>
                                     <div>
                                         <img src="<?php echo base_url(); ?>assets/images/ellep.png" alt="">
                                     </div>
                                 </div>
                                 <div class="row">
                                     <div class="col-md-6 my-1">
                                         <p class="fs2">New & Old Patients</p>
                                         <div class="mt-2">
                                             <div class="blBox2 d-flex justify-content-evenly align-items-center p-2">
                                                 <i class="fa-solid fa-arrow-trend-up fsy6"></i>
                                                 <p class="fsy6 m-0">172.1%</p>
                                             </div>
                                         </div>
                                     </div>
                                     <div class="col-md-6 my-1 d-flex justify-content-end align-items-center">
                                         <img class="img-fluid" src="<?php echo base_url(); ?>assets/images/nop.svg"
                                             alt="">
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                     <div class="my-2 col-md-4">
                         <div class=" mCard p-2">
                             <div class="card-body">
                                 <div class="d-flex justify-content-between align-items-center">
                                     <div class="d-flex justify-content-between align-items-center">
                                         <img src="<?php echo base_url(); ?>assets/images/sti.svg" alt="">
                                         <p class="m-0 ms-2 fs1">Stock Items</p>
                                     </div>
                                     <div>
                                         <img src="<?php echo base_url(); ?>assets/images/ellep.png" alt="">
                                     </div>
                                 </div>
                                 <div class="row">
                                     <div class="col-md-6 my-1">
                                         <p class="fs2 text-wrap">Sync your stock items</p>
                                         <div class="mt-2">
                                             <div class="blBox3 d-flex justify-content-evenly align-items-center p-2">
                                                 <i class="fa-solid fa-arrow-trend-up fs6"></i>
                                                 <p class="fs6 m-0">172.1%</p>
                                             </div>
                                         </div>
                                     </div>
                                     <div class="col-md-6 my-1">
                                         <div class="d-flex justify-content-between">
                                             <div class="d-flex align-items-center ">
                                                 <img src="<?php echo base_url(); ?>assets/images/bdot.png" alt="">
                                                 <p class="mb-0 fs7 ms-1">75.9% </p>
                                             </div>
                                             <div class="d-flex align-items-center ">
                                                 <img src="<?php echo base_url(); ?>assets/images/rdot.png" alt="">
                                                 <p class="mb-0 fs7 ms-1">89.9% </p>
                                             </div>
                                         </div>
                                         <div class=" mt-1 mb-0 d-flex justify-content-end align-items-center"
                                             style="height: 70%;">
                                             <img class="img-fluid"
                                                 src="<?php echo base_url(); ?>assets/images/stio.svg" alt="">
                                         </div>

                                     </div>

                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="mCard p-2">
                     <div class="row">
                         <div class="col-md-4 my-2">
                             <div class="row ps-2">
                                 <div class="col-md-12 my-2">
                                     <div class=" mCard p-2" class="btn btn-primary" data-bs-toggle="modal"
                                         data-bs-target="#exampleModal">
                                         <div class="card-body">
                                             <div class="">
                                                 <div class="d-flex align-items-center">
                                                     <img src="<?php echo base_url(); ?>assets/images/apc.svg" alt="">
                                                     <p class="m-0 ms-2 fs8">Inventory checked out Today</p>

                                                 </div>
                                                 <div
                                                     class="my-2 d-flex justify-content-between align-items-center flex-wrap">
                                                     <p class="fs9 m-0">$30,000</p>
                                                     <div class="d-flex justify-content-between align-items-center">
                                                         <img class="mx-1"
                                                             src="<?php echo base_url(); ?>assets/images/aru.png"
                                                             alt="">
                                                         <p class="mb-0 ff1">2.99%</p>
                                                     </div>
                                                 </div>

                                             </div>

                                         </div>
                                     </div>
                                 </div>
                                 <div class="col-md-12 my-2">
                                     <div class=" mCard p-2">
                                         <div class="card-body">
                                             <div class="">
                                                 <div class="d-flex align-items-center">
                                                     <img src="<?php echo base_url(); ?>assets/images/apii.svg" alt="">
                                                     <p class="m-0 ms-2 fs8">Average Price of inventory items</p>
                                                 </div>
                                                 <div class="my-2 d-flex justify-content-between align-items-center flex-wrap">
                                                     <p class="fs9 m-0">$<?php echo number_format($current_average_price, 2); ?></p>
                                                     <div class="d-flex justify-content-between align-items-center">
                                                         <img class="mx-1" src="<?php echo base_url(); ?>assets/images/<?php echo ($arrow_direction === 'up') ? 'icuppp.svg' : 'icdown.svg'; ?>" alt="">
                                                         <p class="mb-0 fff2"><?php echo number_format($percentage_change, 2); ?>%</p>
                                                     </div>
                                                 </div>
                                             </div>


                                         </div>
                                     </div>
                                 </div>
                                 <div class="col-md-12 my-2">
                                     <div class=" mCard p-2">
                                         <div class="card-body">
                                             <div class="">
                                                 <div class="">
                                                     <div class="d-flex align-items-center">
                                                         <img src="<?php echo base_url(); ?>assets/images/ixs.svg" alt="">
                                                         <p class="m-0 ms-2 fs8">Inventory expiring (30 days)</p>
                                                     </div>
                                                     <div class="my-2 d-flex justify-content-between align-items-center flex-wrap">
                                                         <p class="fs9 m-0">$<?php echo number_format($expiring_cost, 2); ?></p>
                                                         <div class="d-flex justify-content-between align-items-center">
                                                             <img class="mx-1" src="<?php echo base_url(); ?>assets/images/arb.png" alt="">
                                                             <p class="mb-0 ff2"><?php echo number_format($expiring_percentage, 2); ?>%</p>
                                                         </div>
                                                     </div>
                                                 </div>


                                             </div>

                                         </div>
                                     </div>
                                 </div>
                                 <div class="col-md-12 my-2">
                                     <div class=" mCard p-2">
                                         <div class="card-body">
                                             <div class="">
                                                 <div class="d-flex align-items-center">
                                                     <img src="<?php echo base_url(); ?>assets/images/lsi.svg" alt="">
                                                     <p class="m-0 ms-2 fs8">Low Stock Items</p>

                                                 </div>
                                                 <div
                                                     class="my-2 d-flex justify-content-between align-items-center flex-wrap">
                                                     <p class="fs9 m-0"><?php echo $low_quantity ?></p>
                                                     <div class="d-flex justify-content-between align-items-center">
                                                         <img class="mx-1"
                                                             src="<?php echo base_url(); ?>assets/images/arb2.png"
                                                             alt="">
                                                         <p class="mb-0 ff3">2.99%</p>
                                                     </div>
                                                 </div>

                                             </div>

                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         <div class="col-md-8 my-2">
                             <!-- <div class="row pe-4">
                                 <div class="col-md-9 my-2">
                                     <p class="ff4 m-0">Total Inventory</p>
                                     <p class="ff5 m-0">
                                         $<?= number_format($totalCost, 2); ?>
                                     </p>

                                 </div>
                                 <div class="col-md-3 my-2">
                                     <select class="form-select date-selection" name="date-selection"
                                         id="date-selection-1">
                                         <option value="Today" selected>Today</option>
                                         <option value="Yesterday">Yesterday</option>
                                         <option value="This Week">This Week</option>
                                         <option value="Last Week">Last Week</option>
                                         <option value="This Month">This Month</option>
                                         <option value="Last Month">Last Month</option>
                                         <option value="Custom">Custom</option>
                                     </select>
                                     <div class="d-flex d-none date" id="">
                                         <input class="form-control " type="date" class="">
                                         <button class="btn btnRefresh" id=""> <img
                                                 src="<?php echo base_url(); ?>assets/images/reload.svg" alt=""
                                                 width="15px"></button>
                                     </div>
                                 </div>
                             </div> -->
                             <!-- HTML Structure -->
                             <div class="row pe-4">
                                 <div class="col-md-8 my-2">
                                     <p class="ff4 m-0">Total Inventory Cost</p>
                                     <p class="ff5 m-0" id="total-cost">

                                     </p>
                                 </div>
                                 <div class="col-md-4 my-2">
                                     <select class="form-select date-selection" name="date-selection" id="date-selection-1">
                                         <option value="all" selected>Over All</option>
                                         <option value="Today">Today</option>
                                         <option value="Yesterday">Yesterday</option>
                                         <option value="This Week">This Week</option>
                                         <option value="Last Week">Last Week</option>
                                         <option value="This Month">This Month</option>
                                         <option value="Last Month">Last Month</option>
                                         <option value="Custom">Custom</option>
                                     </select>
                                     <div class="d-flex d-none date" id="">
                                         <input class="form-control" type="date" class="">
                                         <button class="btn btnRefresh" id=""> <img src="<?php echo base_url(); ?>assets/images/reload.svg" alt="" width="15px"></button>
                                     </div>
                                 </div>
                             </div>

                             <div>
                                 <div id="chart"></div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="col-md-3 py-2">
                 <div class="mCard p-2">
                     <div class="d-flex justify-content-between align-items-center flex-wrap">
                         <p class="ff4 m-0">Inventory History</p>
                         <div>
                             <img src="<?php echo base_url(); ?>assets/images/ellep.png" alt="">
                         </div>
                     </div>
                     <p class="ff5">Total Stock <br> <?php echo $quantity ?></p>
                     <div class="row  borderB ">
                         <div class="col-md-6 my-2">
                             <div class="d-flex gap-2 align-items-center">
                                 <img src="<?php echo base_url(); ?>assets/images/arau.svg" alt="" class="arowU">
                                 <p class="m-0 fs2">Add Stock Items</p>

                             </div>
                             <p class="ff6">Items <?php echo $letest_quantity ?></p>
                         </div>
                         <div class="col-md-6 my-2">
                             <div class="d-flex gap-2 align-items-center">
                                 <img src="<?php echo base_url(); ?>assets/images/assigned.svg" alt="" class="arowd">
                                 <p class="m-0 fs2">Assinged Items</p>
                             </div>
                             <p class="ff6">Items 10,356</p>
                         </div>
                     </div>
                     <div>


                         <div class="d-flex justify-content-between align-items-center">
                             <p class="ff7 m-0">Popular</p>
                             <p class="fs2 m-0">3 Items</p>
                         </div>
                         <div class="my-2">
                             <div id="chartpie"></div>
                             <div class="my-2">
                                 <div id="product-list">
                                     <!-- Dynamic products will be appended here -->
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
         </div>

 </main>
 <!--end main wrapper-->


 <!--start overlay-->
 <div class="overlay btn-toggle"></div>
 <!--end overlay-->

 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
 <!-- apex chart -->
 <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

 <script>
     let dateselects = document.getElementsByClassName("date-selection");
     let dates = document.getElementsByClassName('date');
     let btnRefreshes = document.getElementsByClassName('btnRefresh');
     let totalCostElement = document.getElementById('total-cost');

     // Function to make AJAX request and update total cost and filtered data
     function updateTotalCost(filter, customDate = '') {
         $.ajax({
             url: 'user/get_inventory_data',
             type: 'POST',
             data: {
                 date_filter: filter,
                 custom_date: customDate
             },
             success: function(response) {
                 try {
                     let parsedResponse = typeof response === 'string' ? JSON.parse(response) : response;
                     let totalCost = parseFloat(parsedResponse.totalCost) || 0;
                     totalCostElement.textContent = `$${totalCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                     // Update chart data
                     updateChart(parsedResponse.categoryDataByDay);

                 } catch (error) {
                     console.error('Error parsing JSON response: ', error);
                     console.error('Received response: ', response);
                 }
             },
             error: function(xhr, status, error) {
                 console.error('AJAX error:', error);
                 console.error('Response:', xhr.responseText);
             }
         });
     }

     // Function to update chart data
     function updateChart(dataByDay) {
         const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

         // Initialize data arrays
         let neurotoxinsData = new Array(7).fill(0);
         let dermalFillersData = new Array(7).fill(0);
         let othersData = new Array(7).fill(0);

         // Map the data to the correct day
         daysOfWeek.forEach((day, index) => {
             if (dataByDay[day]) {
                 neurotoxinsData[index] = dataByDay[day]['Neurotoxins'] || 0;
                 dermalFillersData[index] = dataByDay[day]['Dermal Fillers'] || 0;
                 othersData[index] = dataByDay[day]['Others'] || 0;
             }
         });

         chart.updateSeries([{
                 name: 'Neurotoxins',
                 data: neurotoxinsData
             },
             {
                 name: 'Dermal Fillers',
                 data: dermalFillersData
             },
             {
                 name: 'Others',
                 data: othersData
             },
             {
                 name: 'Total Inventory',
                 data: neurotoxinsData.map((value, index) => value + dermalFillersData[index] + othersData[index])
             }
         ]);
     }

     // Initial load to display total cost
     document.addEventListener('DOMContentLoaded', () => {
         updateTotalCost('all'); // Load total cost for all data initially
     });

     // Event listener to update cost when a filter is applied
     for (let dateselect of dateselects) {
         dateselect.addEventListener('change', () => {
             if (dateselect.value === "Custom") {
                 dateselect.classList.add('d-none');
                 for (let date of dates) {
                     date.classList.remove('d-none');
                     date.querySelector('input[type="date"]').addEventListener('change', function() {
                         updateTotalCost('Custom', this.value);
                     });
                 }
             } else {
                 updateTotalCost(dateselect.value);
             }
         });
     }

     // Refresh button event listener to reset filters
     for (let btnRefresh of btnRefreshes) {
         btnRefresh.addEventListener('click', () => {
             for (let dateselect of dateselects) {
                 dateselect.classList.remove('d-none');
                 dateselect.value = "all";
             }
             for (let date of dates) {
                 date.classList.add('d-none ');
             }
             updateTotalCost('all');
         });
     }

     var options = {
         series: [{
                 name: 'Neurotoxins',
                 type: 'line',
                 data: [50000, 75000, 100000, 125000, 150000, 175000, 200000],
                 color: '#FF5C45'
             },
             {
                 name: 'Dermal Fillers',
                 type: 'line',
                 data: [20000, 60000, 85000, 110000, 135000, 160000, 185000],
                 color: '#5096FF'
             },
             {
                 name: 'Others',
                 type: 'line',
                 data: [0, 20000, 20000, 65000, 80000, 115000, 140000],
                 color: '#693C6B'
             },
             {
                 name: 'Total Inventory',
                 type: 'line',
                 data: [1000, 25000, 50000, 75000, 100000, 125000, 150000],
                 color: '#FFF200'
             },
         ],
         chart: {
             height: 350,
             type: 'line',
             stacked: false,
             toolbar: {
                 show: false
             }
         },
         dataLabels: {
             enabled: false
         },
         stroke: {
             width: 3,
             curve: 'smooth'
         },
         xaxis: {
             categories: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
             labels: {
                 style: {
                     paddingLeft: '20px'
                 }
             }
         },
         yaxis: {
             show: false,
             labels: {
                 formatter: function(val) {
                     return "$" + val;
                 }
             }
         },
         tooltip: {
             enabled: false

         },

     };

     var chart = new ApexCharts(document.querySelector("#chart"), options);
     chart.render();
 </script>



 <script>

     function updatePieChart() {
         $.ajax({
             url: 'user/get_top_products',
             type: 'GET',
             success: function(response) {
                 try {
                     let parsedResponse = typeof response === 'string' ? JSON.parse(response) : response;
                     console.log("Parsed Response:", parsedResponse); // Log the response for debugging

                     let productPercentages = parsedResponse.map(product => product.percentage);
                     chartpie.updateSeries(productPercentages);

                     let productListHtml = '';
                     parsedResponse.forEach((product, index) => {
                         let imageSrc, iconHtml, textColor;
                         switch (index % 3) {
                             case 0:
                                 imageSrc = '<?php echo base_url(); ?>assets/images/m1.png';
                                 iconHtml = '<img class="mx-1" src="https://buzzwaretech.com/myesthatic/assets/images/ru.png" alt="">';
                                 textColor = 'ff2';
                                 break;
                             case 1:
                                 imageSrc = '<?php echo base_url(); ?>assets/images/m1.png';
                                 iconHtml = '<i class="fa-solid fa-arrow-up fsy6"></i>';
                                 textColor = 'fsy6';
                                 break;
                             case 2:
                                 imageSrc = '<?php echo base_url(); ?>assets/images/m1.png';
                                 iconHtml = '<img class="mx-1" src="https://buzzwaretech.com/myesthatic/assets/images/bu.png" alt="">';
                                 textColor = 'fff3';
                                 break;
                         }
                         productListHtml += `
                            <div class="d-flex justify-content-between align-items-center flex-wrap my-2">
                                <div class="d-flex gap-1 align-items-center">
                                    <div class="mBox">
                                        <img src="${imageSrc}" alt="">
                                    </div>
                                    <p class="m-0 ff8">${product.name}</p>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    ${iconHtml}
                                    <p class="mb-0 ${textColor}">${product.percentage.toFixed(2)}%</p>
                                </div>
                            </div>
                        `;
                     });


                     document.querySelector('#product-list').innerHTML = productListHtml;

                 } catch (error) {
                     console.error('Error parsing JSON response: ', error);
                     console.error('Received response: ', response);
                 }
             },
             error: function(xhr, status, error) {
                 console.error('AJAX error:', error);
                 console.error('Response:', xhr.responseText);
             }
         });
     }

     // Initial load to display top products
     document.addEventListener('DOMContentLoaded', () => {
         updatePieChart(); // Load top products initially
     });

     // Pie chart
     var optionsp = {
         series: [], // Initial empty data
         colors: ['#FF5C45', '#FFF200', '#5096FF'],
         chart: {
             width: 240,
             type: 'donut',
             radius: ['40%', '70%']
         },
         legend: {
             show: false
         },
         dataLabels: {
             enabled: false // Hide data labels
         },
         responsive: [{
             breakpoint: 480,
             options: {
                 chart: {
                     width: 200
                 }
             }
         }]
     };

     var chartpie = new ApexCharts(document.querySelector("#chartpie"), optionsp);
     chartpie.render();
 </script>